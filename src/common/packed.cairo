use array::ArrayTrait;
use cmp::min;
use integer::{u256_safe_div_rem, u256_as_non_zero};
use option::OptionTrait;
use traits::{Into, TryInto};
use zeroable::Zeroable;

use influence::types::array::ArrayTraitExt;

const PACKED_MAX: u256 = 0x400000000000000000000000000000000000000000000000000000000000000;
const EXP2_0: u128 = 0x1; // 2^0
const EXP2_1: u128 = 0x2; // 2^1
const EXP2_2: u128 = 0x4; // 2^2
const EXP2_3: u128 = 0x8; // 2^3
const EXP2_4: u128 = 0x10; // 2^4
const EXP2_5: u128 = 0x20; // 2^5
const EXP2_6: u128 = 0x40; // 2^6
const EXP2_7: u128 = 0x80; // 2^7
const EXP2_8: u128 = 0x100; // 2^8
const EXP2_9: u128 = 0x200; // 2^9
const EXP2_10: u128 = 0x400; // 2^10
const EXP2_11: u128 = 0x800; // 2^11
const EXP2_12: u128 = 0x1000; // 2^12
const EXP2_13: u128 = 0x2000; // 2^13
const EXP2_14: u128 = 0x4000; // 2^14
const EXP2_15: u128 = 0x8000; // 2^15
const EXP2_16: u128 = 0x10000; // 2^16
const EXP2_17: u128 = 0x20000; // 2^17
const EXP2_18: u128 = 0x40000; // 2^18
const EXP2_19: u128 = 0x80000; // 2^19
const EXP2_20: u128 = 0x100000; // 2^20
const EXP2_21: u128 = 0x200000; // 2^21
const EXP2_22: u128 = 0x400000; // 2^22
const EXP2_23: u128 = 0x800000; // 2^23
const EXP2_24: u128 = 0x1000000; // 2^24
const EXP2_25: u128 = 0x2000000; // 2^25
const EXP2_26: u128 = 0x4000000; // 2^26
const EXP2_27: u128 = 0x8000000; // 2^27
const EXP2_28: u128 = 0x10000000; // 2^28
const EXP2_29: u128 = 0x20000000; // 2^29
const EXP2_30: u128 = 0x40000000; // 2^30
const EXP2_31: u128 = 0x80000000; // 2^31
const EXP2_32: u128 = 0x100000000; // 2^32
const EXP2_33: u128 = 0x200000000; // 2^33
const EXP2_34: u128 = 0x400000000; // 2^34
const EXP2_35: u128 = 0x800000000; // 2^35
const EXP2_36: u128 = 0x1000000000; // 2^36
const EXP2_37: u128 = 0x2000000000; // 2^37
const EXP2_38: u128 = 0x4000000000; // 2^38
const EXP2_39: u128 = 0x8000000000; // 2^39
const EXP2_40: u128 = 0x10000000000; // 2^40
const EXP2_41: u128 = 0x20000000000; // 2^41
const EXP2_42: u128 = 0x40000000000; // 2^42
const EXP2_43: u128 = 0x80000000000; // 2^43
const EXP2_44: u128 = 0x100000000000; // 2^44
const EXP2_45: u128 = 0x200000000000; // 2^45
const EXP2_46: u128 = 0x400000000000; // 2^46
const EXP2_47: u128 = 0x800000000000; // 2^47
const EXP2_48: u128 = 0x1000000000000; // 2^48
const EXP2_49: u128 = 0x2000000000000; // 2^49
const EXP2_50: u128 = 0x4000000000000; // 2^50
const EXP2_51: u128 = 0x8000000000000; // 2^51
const EXP2_52: u128 = 0x10000000000000; // 2^52
const EXP2_53: u128 = 0x20000000000000; // 2^53
const EXP2_54: u128 = 0x40000000000000; // 2^54
const EXP2_55: u128 = 0x80000000000000; // 2^55
const EXP2_56: u128 = 0x100000000000000; // 2^56
const EXP2_57: u128 = 0x200000000000000; // 2^57
const EXP2_58: u128 = 0x400000000000000; // 2^58
const EXP2_59: u128 = 0x800000000000000; // 2^59
const EXP2_60: u128 = 0x1000000000000000; // 2^60
const EXP2_61: u128 = 0x2000000000000000; // 2^61
const EXP2_62: u128 = 0x4000000000000000; // 2^62
const EXP2_63: u128 = 0x8000000000000000; // 2^63
const EXP2_64: u128 = 0x10000000000000000; // 2^64
const EXP2_65: u128 = 0x20000000000000000; // 2^65
const EXP2_66: u128 = 0x40000000000000000; // 2^66
const EXP2_67: u128 = 0x80000000000000000; // 2^67
const EXP2_68: u128 = 0x100000000000000000; // 2^68
const EXP2_69: u128 = 0x200000000000000000; // 2^69
const EXP2_70: u128 = 0x400000000000000000; // 2^70
const EXP2_71: u128 = 0x800000000000000000; // 2^71
const EXP2_72: u128 = 0x1000000000000000000; // 2^72
const EXP2_73: u128 = 0x2000000000000000000; // 2^73
const EXP2_74: u128 = 0x4000000000000000000; // 2^74
const EXP2_75: u128 = 0x8000000000000000000; // 2^75
const EXP2_76: u128 = 0x10000000000000000000; // 2^76
const EXP2_77: u128 = 0x20000000000000000000; // 2^77
const EXP2_78: u128 = 0x40000000000000000000; // 2^78
const EXP2_79: u128 = 0x80000000000000000000; // 2^79
const EXP2_80: u128 = 0x100000000000000000000; // 2^80
const EXP2_81: u128 = 0x200000000000000000000; // 2^81
const EXP2_82: u128 = 0x400000000000000000000; // 2^82
const EXP2_83: u128 = 0x800000000000000000000; // 2^83
const EXP2_84: u128 = 0x1000000000000000000000; // 2^84
const EXP2_85: u128 = 0x2000000000000000000000; // 2^85
const EXP2_86: u128 = 0x4000000000000000000000; // 2^86
const EXP2_87: u128 = 0x8000000000000000000000; // 2^87
const EXP2_88: u128 = 0x10000000000000000000000; // 2^88
const EXP2_89: u128 = 0x20000000000000000000000; // 2^89
const EXP2_90: u128 = 0x40000000000000000000000; // 2^90
const EXP2_91: u128 = 0x80000000000000000000000; // 2^91
const EXP2_92: u128 = 0x100000000000000000000000; // 2^92
const EXP2_93: u128 = 0x200000000000000000000000; // 2^93
const EXP2_94: u128 = 0x400000000000000000000000; // 2^94
const EXP2_95: u128 = 0x800000000000000000000000; // 2^95
const EXP2_96: u128 = 0x1000000000000000000000000; // 2^96
const EXP2_97: u128 = 0x2000000000000000000000000; // 2^97
const EXP2_98: u128 = 0x4000000000000000000000000; // 2^98
const EXP2_99: u128 = 0x8000000000000000000000000; // 2^99
const EXP2_100: u128 = 0x10000000000000000000000000; // 2^100
const EXP2_101: u128 = 0x20000000000000000000000000; // 2^101
const EXP2_102: u128 = 0x40000000000000000000000000; // 2^102
const EXP2_103: u128 = 0x80000000000000000000000000; // 2^103
const EXP2_104: u128 = 0x100000000000000000000000000; // 2^104
const EXP2_105: u128 = 0x200000000000000000000000000; // 2^105
const EXP2_106: u128 = 0x400000000000000000000000000; // 2^106
const EXP2_107: u128 = 0x800000000000000000000000000; // 2^107
const EXP2_108: u128 = 0x1000000000000000000000000000; // 2^108
const EXP2_109: u128 = 0x2000000000000000000000000000; // 2^109
const EXP2_110: u128 = 0x4000000000000000000000000000; // 2^110
const EXP2_111: u128 = 0x8000000000000000000000000000; // 2^111
const EXP2_112: u128 = 0x10000000000000000000000000000; // 2^112
const EXP2_113: u128 = 0x20000000000000000000000000000; // 2^113
const EXP2_114: u128 = 0x40000000000000000000000000000; // 2^114
const EXP2_115: u128 = 0x80000000000000000000000000000; // 2^115
const EXP2_116: u128 = 0x100000000000000000000000000000; // 2^116
const EXP2_117: u128 = 0x200000000000000000000000000000; // 2^117
const EXP2_118: u128 = 0x400000000000000000000000000000; // 2^118
const EXP2_119: u128 = 0x800000000000000000000000000000; // 2^119
const EXP2_120: u128 = 0x1000000000000000000000000000000; // 2^120
const EXP2_121: u128 = 0x2000000000000000000000000000000; // 2^121
const EXP2_122: u128 = 0x4000000000000000000000000000000; // 2^122
const EXP2_123: u128 = 0x8000000000000000000000000000000; // 2^123
const EXP2_124: u128 = 0x10000000000000000000000000000000; // 2^124
const EXP2_125: u128 = 0x20000000000000000000000000000000; // 2^125
const EXP2_126: u128 = 0x40000000000000000000000000000000; // 2^126
const EXP2_127: u128 = 0x80000000000000000000000000000000; // 2^127
const EXP2_128: felt252 = 0x100000000000000000000000000000000; // 2^128

#[inline(always)]
fn split_felt252(packed: felt252) -> (u128, u128) {
    return match integer::u128s_from_felt252(packed) {
        integer::U128sFromFelt252Result::Narrow(low) => (low, 0),
        integer::U128sFromFelt252Result::Wide((high, low)) => (low, high)
    };
}

#[inline(always)]
fn pack_u128(ref packed: u128, shift: u128, width: u128, value: u128) {
    assert(value < width, 'pack value too large');
    packed += value * shift;
}

#[inline(always)]
fn unpack_u128(packed: u128, shift: u128, width: u128) -> u128 {
    return (packed / shift) % width;
}


// Tests --------------------------------------------------------------------------------------------------------------

#[cfg(test)]
mod tests {
    #[test]
    #[available_gas(40000)]
    fn test_pack_u128() {
        let mut prepacked = 2730;
        super::pack_u128(ref prepacked, super::EXP2_0, super::EXP2_4, 10);
        assert(prepacked == 2740, 'Not equal to 2740');
    }
}