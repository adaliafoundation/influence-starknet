use cubit::f64::{Fixed, FixedTrait, HALF, ONE};

fn percentile(noise: Fixed, octaves: u64) -> Fixed {
    let mut bracket = (0, 0, 0);
    let mut noise_arg = noise.mag;
    let mut upper = false;

    // If noise is larger than half, invert and add half
    if noise.mag > HALF {
        noise_arg = ONE - noise.mag;
        upper = true;
    }

    if octaves == 2 {
        bracket = octaves_2(noise_arg);
    } else if octaves == 3 {
        bracket = octaves_3(noise_arg);
    } else if octaves == 4 {
        bracket = octaves_4(noise_arg);
    } else if octaves == 5 {
        bracket = octaves_5(noise_arg);
    } else if octaves == 6 {
        bracket = octaves_6(noise_arg);
    }

    let (whole, low, high) = bracket;

    // Set noise_arg to zero if at the very bottom of the range (will result in 0% or 100% percentile)
    if whole == 0 && noise_arg <= low {
        noise_arg = low;
    }

    let partial = FixedTrait::new(noise_arg - low, false) / FixedTrait::new(100 * (high - low), false);
    let mut percentile = FixedTrait::new(whole + partial.mag, false);

    if upper {
        percentile = FixedTrait::ONE() - percentile;
    }

    return percentile;
}

fn octaves_2(noise: u64) -> (u64, u64, u64) {
    if noise < 848946201 { return (0, 573229616, 848946201); }
    if noise < 968908012 { return (42949673, 848946201, 968908012); }
    if noise < 1051323919 { return (85899346, 968908012, 1051323919); }
    if noise < 1118070985 { return (128849019, 1051323919, 1118070985); }
    if noise < 1175636393 { return (171798692, 1118070985, 1175636393); }
    if noise < 1225770992 { return (214748365, 1175636393, 1225770992); }
    if noise < 1271912851 { return (257698038, 1225770992, 1271912851); }
    if noise < 1313849605 { return (300647711, 1271912851, 1313849605); }
    if noise < 1352768668 { return (343597384, 1313849605, 1352768668); }
    if noise < 1388845262 { return (386547057, 1352768668, 1388845262); }
    if noise < 1422491308 { return (429496730, 1388845262, 1422491308); }
    if noise < 1454091450 { return (472446403, 1422491308, 1454091450); }
    if noise < 1483916412 { return (515396076, 1454091450, 1483916412); }
    if noise < 1512394034 { return (558345748, 1483916412, 1512394034); }
    if noise < 1539301568 { return (601295421, 1512394034, 1539301568); }
    if noise < 1564762205 { return (644245094, 1539301568, 1564762205); }
    if noise < 1589850542 { return (687194767, 1564762205, 1589850542); }
    if noise < 1613525399 { return (730144440, 1589850542, 1613525399); }
    if noise < 1636539464 { return (773094113, 1613525399, 1636539464); }
    if noise < 1658075781 { return (816043786, 1636539464, 1658075781); }
    if noise < 1679064731 { return (858993459, 1658075781, 1679064731); }
    if noise < 1699927333 { return (901943132, 1679064731, 1699927333); }
    if noise < 1720007568 { return (944892805, 1699927333, 1720007568); }
    if noise < 1739820779 { return (987842478, 1720007568, 1739820779); }
    if noise < 1758707550 { return (1030792151, 1739820779, 1758707550); }
    if noise < 1776759452 { return (1073741824, 1758707550, 1776759452); }
    if noise < 1794498777 { return (1116691497, 1776759452, 1794498777); }
    if noise < 1811935497 { return (1159641170, 1794498777, 1811935497); }
    if noise < 1829058542 { return (1202590843, 1811935497, 1829058542); }
    if noise < 1845876957 { return (1245540516, 1829058542, 1845876957); }
    if noise < 1862579281 { return (1288490189, 1845876957, 1862579281); }
    if noise < 1878797337 { return (1331439862, 1862579281, 1878797337); }
    if noise < 1895077414 { return (1374389535, 1878797337, 1895077414); }
    if noise < 1910893965 { return (1417339208, 1895077414, 1910893965); }
    if noise < 1926557796 { return (1460288881, 1910893965, 1926557796); }
    if noise < 1942056614 { return (1503238554, 1926557796, 1942056614); }
    if noise < 1957067944 { return (1546188227, 1942056614, 1957067944); }
    if noise < 1972258853 { return (1589137900, 1957067944, 1972258853); }
    if noise < 1987222735 { return (1632087572, 1972258853, 1987222735); }
    if noise < 2002264257 { return (1675037245, 1987222735, 2002264257); }
    if noise < 2017172007 { return (1717986918, 2002264257, 2017172007); }
    if noise < 2032094810 { return (1760936591, 2017172007, 2032094810); }
    if noise < 2046695632 { return (1803886264, 2032094810, 2046695632); }
    if noise < 2061488353 { return (1846835937, 2046695632, 2061488353); }
    if noise < 2076088588 { return (1889785610, 2061488353, 2076088588); }
    if noise < 2090616875 { return (1932735283, 2076088588, 2090616875); }
    if noise < 2104944337 { return (1975684956, 2090616875, 2104944337); }
    if noise < 2119218642 { return (2018634629, 2104944337, 2119218642); }
    if noise < 2133640950 { return (2061584302, 2119218642, 2133640950); }
    if noise < 2147483648 { return (2104533975, 2133640950, 2147483648); }
    return (0, 0, 0);
}

fn octaves_3(noise: u64) -> (u64, u64, u64) {
    if noise < 1003729318 { return (0, 746972896, 1003729318); }
    if noise < 1112967622 { return (42949673, 1003729318, 1112967622); }
    if noise < 1188221964 { return (85899346, 1112967622, 1188221964); }
    if noise < 1247298913 { return (128849019, 1188221964, 1247298913); }
    if noise < 1297888369 { return (171798692, 1247298913, 1297888369); }
    if noise < 1341616824 { return (214748365, 1297888369, 1341616824); }
    if noise < 1381434740 { return (257698038, 1341616824, 1381434740); }
    if noise < 1417202381 { return (300647711, 1381434740, 1417202381); }
    if noise < 1450687184 { return (343597384, 1417202381, 1450687184); }
    if noise < 1482185195 { return (386547057, 1450687184, 1482185195); }
    if noise < 1511073427 { return (429496730, 1482185195, 1511073427); }
    if noise < 1538387041 { return (472446403, 1511073427, 1538387041); }
    if noise < 1563881308 { return (515396076, 1538387041, 1563881308); }
    if noise < 1588822139 { return (558345748, 1563881308, 1588822139); }
    if noise < 1612336621 { return (601295421, 1588822139, 1612336621); }
    if noise < 1634991794 { return (644245094, 1612336621, 1634991794); }
    if noise < 1656797242 { return (687194767, 1634991794, 1656797242); }
    if noise < 1677196154 { return (730144440, 1656797242, 1677196154); }
    if noise < 1696924085 { return (773094113, 1677196154, 1696924085); }
    if noise < 1716320883 { return (816043786, 1696924085, 1716320883); }
    if noise < 1734677560 { return (858993459, 1716320883, 1734677560); }
    if noise < 1752779649 { return (901943132, 1734677560, 1752779649); }
    if noise < 1770333812 { return (944892805, 1752779649, 1770333812); }
    if noise < 1787379866 { return (987842478, 1770333812, 1787379866); }
    if noise < 1803876932 { return (1030792151, 1787379866, 1803876932); }
    if noise < 1819974870 { return (1073741824, 1803876932, 1819974870); }
    if noise < 1835925287 { return (1116691497, 1819974870, 1835925287); }
    if noise < 1851512849 { return (1159641170, 1835925287, 1851512849); }
    if noise < 1866356930 { return (1202590843, 1851512849, 1866356930); }
    if noise < 1881291798 { return (1245540516, 1866356930, 1881291798); }
    if noise < 1895843475 { return (1288490189, 1881291798, 1895843475); }
    if noise < 1910243034 { return (1331439862, 1895843475, 1910243034); }
    if noise < 1924341009 { return (1374389535, 1910243034, 1924341009); }
    if noise < 1938403936 { return (1417339208, 1924341009, 1938403936); }
    if noise < 1952161963 { return (1460288881, 1938403936, 1952161963); }
    if noise < 1965938956 { return (1503238554, 1952161963, 1965938956); }
    if noise < 1979615213 { return (1546188227, 1965938956, 1979615213); }
    if noise < 1993060934 { return (1589137900, 1979615213, 1993060934); }
    if noise < 2006204071 { return (1632087572, 1993060934, 2006204071); }
    if noise < 2019293607 { return (1675037245, 2006204071, 2019293607); }
    if noise < 2032417417 { return (1717986918, 2019293607, 2032417417); }
    if noise < 2045347680 { return (1760936591, 2032417417, 2045347680); }
    if noise < 2058235220 { return (1803886264, 2045347680, 2058235220); }
    if noise < 2071063775 { return (1846835937, 2058235220, 2071063775); }
    if noise < 2083946846 { return (1889785610, 2071063775, 2083946846); }
    if noise < 2096839726 { return (1932735283, 2083946846, 2096839726); }
    if noise < 2109376552 { return (1975684956, 2096839726, 2109376552); }
    if noise < 2122074850 { return (2018634629, 2109376552, 2122074850); }
    if noise < 2134816656 { return (2061584302, 2122074850, 2134816656); }
    if noise < 2147483648 { return (2104533975, 2134816656, 2147483648); }
    return (0, 0, 0);
}

fn octaves_4(noise: u64) -> (u64, u64, u64) {
    if noise < 1072880515 { return (0, 830969936, 1072880515); }
    if noise < 1176578584 { return (42949673, 1072880515, 1176578584); }
    if noise < 1247816935 { return (85899346, 1176578584, 1247816935); }
    if noise < 1303427501 { return (128849019, 1247816935, 1303427501); }
    if noise < 1352401573 { return (171798692, 1303427501, 1352401573); }
    if noise < 1393731685 { return (214748365, 1352401573, 1393731685); }
    if noise < 1430898545 { return (257698038, 1393731685, 1430898545); }
    if noise < 1465090509 { return (300647711, 1430898545, 1465090509); }
    if noise < 1495717195 { return (343597384, 1465090509, 1495717195); }
    if noise < 1524580290 { return (386547057, 1495717195, 1524580290); }
    if noise < 1551576897 { return (429496730, 1524580290, 1551576897); }
    if noise < 1577269574 { return (472446403, 1551576897, 1577269574); }
    if noise < 1601996252 { return (515396076, 1577269574, 1601996252); }
    if noise < 1624930782 { return (558345748, 1601996252, 1624930782); }
    if noise < 1646621521 { return (601295421, 1624930782, 1646621521); }
    if noise < 1667624628 { return (644245094, 1646621521, 1667624628); }
    if noise < 1687925911 { return (687194767, 1667624628, 1687925911); }
    if noise < 1707272059 { return (730144440, 1687925911, 1707272059); }
    if noise < 1725836186 { return (773094113, 1707272059, 1725836186); }
    if noise < 1743381270 { return (816043786, 1725836186, 1743381270); }
    if noise < 1760397041 { return (858993459, 1743381270, 1760397041); }
    if noise < 1777224450 { return (901943132, 1760397041, 1777224450); }
    if noise < 1793469523 { return (944892805, 1777224450, 1793469523); }
    if noise < 1809540913 { return (987842478, 1793469523, 1809540913); }
    if noise < 1825156690 { return (1030792151, 1809540913, 1825156690); }
    if noise < 1840041898 { return (1073741824, 1825156690, 1840041898); }
    if noise < 1854745873 { return (1116691497, 1840041898, 1854745873); }
    if noise < 1869484130 { return (1159641170, 1854745873, 1869484130); }
    if noise < 1883686342 { return (1202590843, 1869484130, 1883686342); }
    if noise < 1897566634 { return (1245540516, 1883686342, 1897566634); }
    if noise < 1911322911 { return (1288490189, 1897566634, 1911322911); }
    if noise < 1925062204 { return (1331439862, 1911322911, 1925062204); }
    if noise < 1938401984 { return (1374389535, 1925062204, 1938401984); }
    if noise < 1951619058 { return (1417339208, 1938401984, 1951619058); }
    if noise < 1964636207 { return (1460288881, 1951619058, 1964636207); }
    if noise < 1977618785 { return (1503238554, 1964636207, 1977618785); }
    if noise < 1990157321 { return (1546188227, 1977618785, 1990157321); }
    if noise < 2002613111 { return (1589137900, 1990157321, 2002613111); }
    if noise < 2015276992 { return (1632087572, 2002613111, 2015276992); }
    if noise < 2027866361 { return (1675037245, 2015276992, 2027866361); }
    if noise < 2040348549 { return (1717986918, 2027866361, 2040348549); }
    if noise < 2052443905 { return (1760936591, 2040348549, 2052443905); }
    if noise < 2064592967 { return (1803886264, 2052443905, 2064592967); }
    if noise < 2076637786 { return (1846835937, 2064592967, 2076637786); }
    if noise < 2088826863 { return (1889785610, 2076637786, 2088826863); }
    if noise < 2100928778 { return (1932735283, 2088826863, 2100928778); }
    if noise < 2112738797 { return (1975684956, 2100928778, 2112738797); }
    if noise < 2124492746 { return (2018634629, 2112738797, 2124492746); }
    if noise < 2136593168 { return (2061584302, 2124492746, 2136593168); }
    if noise < 2147483648 { return (2104533975, 2136593168, 2147483648); }
    return (0, 0, 0);
}

fn octaves_5(noise: u64) -> (u64, u64, u64) {
    if noise < 1105675116 { return (0, 867925108, 1105675116); }
    if noise < 1205305831 { return (42949673, 1105675116, 1205305831); }
    if noise < 1274097799 { return (85899346, 1205305831, 1274097799); }
    if noise < 1329643194 { return (128849019, 1274097799, 1329643194); }
    if noise < 1375390613 { return (171798692, 1329643194, 1375390613); }
    if noise < 1415699742 { return (214748365, 1375390613, 1415699742); }
    if noise < 1451891615 { return (257698038, 1415699742, 1451891615); }
    if noise < 1484106003 { return (300647711, 1451891615, 1484106003); }
    if noise < 1514832740 { return (343597384, 1484106003, 1514832740); }
    if noise < 1542900669 { return (386547057, 1514832740, 1542900669); }
    if noise < 1569630505 { return (429496730, 1542900669, 1569630505); }
    if noise < 1594572466 { return (472446403, 1569630505, 1594572466); }
    if noise < 1618511373 { return (515396076, 1594572466, 1618511373); }
    if noise < 1640922272 { return (558345748, 1618511373, 1640922272); }
    if noise < 1661812605 { return (601295421, 1640922272, 1661812605); }
    if noise < 1682199821 { return (644245094, 1661812605, 1682199821); }
    if noise < 1701668901 { return (687194767, 1682199821, 1701668901); }
    if noise < 1720010752 { return (730144440, 1701668901, 1720010752); }
    if noise < 1737826326 { return (773094113, 1720010752, 1737826326); }
    if noise < 1755371147 { return (816043786, 1737826326, 1755371147); }
    if noise < 1772435087 { return (858993459, 1755371147, 1772435087); }
    if noise < 1788625117 { return (901943132, 1772435087, 1788625117); }
    if noise < 1804131977 { return (944892805, 1788625117, 1804131977); }
    if noise < 1819319520 { return (987842478, 1804131977, 1819319520); }
    if noise < 1834672045 { return (1030792151, 1819319520, 1834672045); }
    if noise < 1849180257 { return (1073741824, 1834672045, 1849180257); }
    if noise < 1863709778 { return (1116691497, 1849180257, 1863709778); }
    if noise < 1877804932 { return (1159641170, 1863709778, 1877804932); }
    if noise < 1891570761 { return (1202590843, 1877804932, 1891570761); }
    if noise < 1905247284 { return (1245540516, 1891570761, 1905247284); }
    if noise < 1918696846 { return (1288490189, 1905247284, 1918696846); }
    if noise < 1931650683 { return (1331439862, 1918696846, 1931650683); }
    if noise < 1944591514 { return (1374389535, 1931650683, 1944591514); }
    if noise < 1957249041 { return (1417339208, 1944591514, 1957249041); }
    if noise < 1969877602 { return (1460288881, 1957249041, 1969877602); }
    if noise < 1982365862 { return (1503238554, 1969877602, 1982365862); }
    if noise < 1994764442 { return (1546188227, 1982365862, 1994764442); }
    if noise < 2006999440 { return (1589137900, 1994764442, 2006999440); }
    if noise < 2018959003 { return (1632087572, 2006999440, 2018959003); }
    if noise < 2030866839 { return (1675037245, 2018959003, 2030866839); }
    if noise < 2042934123 { return (1717986918, 2030866839, 2042934123); }
    if noise < 2054778374 { return (1760936591, 2042934123, 2054778374); }
    if noise < 2066392836 { return (1803886264, 2054778374, 2066392836); }
    if noise < 2078259485 { return (1846835937, 2066392836, 2078259485); }
    if noise < 2090069839 { return (1889785610, 2078259485, 2090069839); }
    if noise < 2101615196 { return (1932735283, 2090069839, 2101615196); }
    if noise < 2113103276 { return (1975684956, 2101615196, 2113103276); }
    if noise < 2124412700 { return (2018634629, 2113103276, 2124412700); }
    if noise < 2135904947 { return (2061584302, 2124412700, 2135904947); }
    if noise < 2147483648 { return (2104533975, 2135904947, 2147483648); }
    return (0, 0, 0);
}

fn octaves_6(noise: u64) -> (u64, u64, u64) {
    if noise < 1121713556 { return (0, 882407860, 1121713556); }
    if noise < 1221068782 { return (42949673, 1121713556, 1221068782); }
    if noise < 1289044739 { return (85899346, 1221068782, 1289044739); }
    if noise < 1342005626 { return (128849019, 1289044739, 1342005626); }
    if noise < 1386520666 { return (171798692, 1342005626, 1386520666); }
    if noise < 1426798491 { return (214748365, 1386520666, 1426798491); }
    if noise < 1462726631 { return (257698038, 1426798491, 1462726631); }
    if noise < 1495476397 { return (300647711, 1462726631, 1495476397); }
    if noise < 1525088961 { return (343597384, 1495476397, 1525088961); }
    if noise < 1552371615 { return (386547057, 1525088961, 1552371615); }
    if noise < 1578668867 { return (429496730, 1552371615, 1578668867); }
    if noise < 1603280027 { return (472446403, 1578668867, 1603280027); }
    if noise < 1626509637 { return (515396076, 1603280027, 1626509637); }
    if noise < 1648747689 { return (558345748, 1626509637, 1648747689); }
    if noise < 1669636400 { return (601295421, 1648747689, 1669636400); }
    if noise < 1689671835 { return (644245094, 1669636400, 1689671835); }
    if noise < 1708967431 { return (687194767, 1689671835, 1708967431); }
    if noise < 1727373413 { return (730144440, 1708967431, 1727373413); }
    if noise < 1745121457 { return (773094113, 1727373413, 1745121457); }
    if noise < 1761815223 { return (816043786, 1745121457, 1761815223); }
    if noise < 1778364458 { return (858993459, 1761815223, 1778364458); }
    if noise < 1794562841 { return (901943132, 1778364458, 1794562841); }
    if noise < 1810102265 { return (944892805, 1794562841, 1810102265); }
    if noise < 1824844774 { return (987842478, 1810102265, 1824844774); }
    if noise < 1839440376 { return (1030792151, 1824844774, 1839440376); }
    if noise < 1853792351 { return (1073741824, 1839440376, 1853792351); }
    if noise < 1867868977 { return (1116691497, 1853792351, 1867868977); }
    if noise < 1881748968 { return (1159641170, 1867868977, 1881748968); }
    if noise < 1895132030 { return (1202590843, 1881748968, 1895132030); }
    if noise < 1908571983 { return (1245540516, 1895132030, 1908571983); }
    if noise < 1921655917 { return (1288490189, 1908571983, 1921655917); }
    if noise < 1934504200 { return (1331439862, 1921655917, 1934504200); }
    if noise < 1947402214 { return (1374389535, 1934504200, 1947402214); }
    if noise < 1960268671 { return (1417339208, 1947402214, 1960268671); }
    if noise < 1972576617 { return (1460288881, 1960268671, 1972576617); }
    if noise < 1984628967 { return (1503238554, 1972576617, 1984628967); }
    if noise < 1996915054 { return (1546188227, 1984628967, 1996915054); }
    if noise < 2008832830 { return (1589137900, 1996915054, 2008832830); }
    if noise < 2020586435 { return (1632087572, 2008832830, 2020586435); }
    if noise < 2032309681 { return (1675037245, 2020586435, 2032309681); }
    if noise < 2043890679 { return (1717986918, 2032309681, 2043890679); }
    if noise < 2055676670 { return (1760936591, 2043890679, 2055676670); }
    if noise < 2067237569 { return (1803886264, 2055676670, 2067237569); }
    if noise < 2078853551 { return (1846835937, 2067237569, 2078853551); }
    if noise < 2090297305 { return (1889785610, 2078853551, 2090297305); }
    if noise < 2101478075 { return (1932735283, 2090297305, 2101478075); }
    if noise < 2112702373 { return (1975684956, 2101478075, 2112702373); }
    if noise < 2124091021 { return (2018634629, 2112702373, 2124091021); }
    if noise < 2135575513 { return (2061584302, 2124091021, 2135575513); }
    if noise < 2147483648 { return (2104533975, 2135575513, 2147483648); }
    return (0, 0, 0);
}

// Tests --------------------------------------------------------------------------------------------------------------

#[cfg(test)]
mod tests {
    use cubit::f64::{Fixed, FixedTrait, ONE};

    #[test]
    #[available_gas(1000000)]
    fn test_noise_dist() {
        let mut res = super::percentile(FixedTrait::new(848946201, false), 2);
        assert(res == FixedTrait::new(42949673, false), 'should be one');

        res = super::percentile(FixedTrait::new(573229616, false), 2);
        assert(res == FixedTrait::ZERO(), 'should be zero');

        res = super::percentile(FixedTrait::new(1510282679, false), 6);
        assert(res == FixedTrait::new(365072220, false), 'should be 0.085');

        res = super::percentile(FixedTrait::new(2362232013, false), 4);
        assert(res == FixedTrait::new(2895872989, false), 'should be ~0.67');

        res = super::percentile(FixedTrait::new(3215577050, false), 6);
        assert(res == FixedTrait::new(4259613650, false), 'should be ~0.99');

        res = super::percentile(FixedTrait::new(3974960847, false), 3);
        assert(res == FixedTrait::new(4294967296, false), 'should be 1');
    }
}